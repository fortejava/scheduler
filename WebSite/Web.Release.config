<?xml version="1.0" encoding="utf-8"?>
<!--
  =============================================================================
  WEB.CONFIG TRANSFORMATION FOR PRODUCTION RELEASE
  =============================================================================

  This transformation is applied when publishing with Release configuration.

  Changes Applied:
  - Disable debug compilation (performance)
  - Enable custom errors (security - hide detailed errors from users)
  - Use production connection string (from environment variable)
  - Remove unnecessary HTTP modules

  Documentation: See docs/07-deployment/IIS_DEPLOYMENT_GUIDE.md
  =============================================================================
-->
<configuration xmlns:xdt="http://schemas.microsoft.com/XML-Document-Transform">

  <!-- ============================================
       SYSTEM.WEB: Core ASP.NET Configuration
       ============================================ -->
  <system.web>

    <!-- DISABLE DEBUG MODE (Production Performance) -->
    <compilation xdt:Transform="RemoveAttributes(debug)" />

    <!--
      CUSTOM ERRORS: Show friendly error pages, not detailed exceptions
      - "On": Always show custom error pages
      - "RemoteOnly": Show detailed errors only on localhost

      SECURITY: Never show detailed errors in production (information disclosure)
    -->
    <customErrors mode="On" defaultRedirect="~/Error.html" xdt:Transform="Replace">
      <error statusCode="404" redirect="~/Error404.html" />
      <error statusCode="500" redirect="~/Error500.html" />
    </customErrors>

  </system.web>

  <!-- ============================================
       CONNECTION STRINGS: Database Configuration
       ============================================ -->

  <!--
    OPTION 1: Use Environment Variable (Recommended for Docker/Azure)

    Set environment variable before deployment:
    PowerShell: $env:SCHEDULER_CONNECTION_STRING = "your-connection-string"
    Docker: -e SCHEDULER_CONNECTION_STRING="your-connection-string"

    To use this, uncomment below and comment out OPTION 2:
  -->
  <!--
  <connectionStrings>
    <add name="schedulerEntities"
         connectionString="#{SCHEDULER_CONNECTION_STRING}#"
         providerName="System.Data.EntityClient"
         xdt:Transform="SetAttributes"
         xdt:Locator="Match(name)" />
  </connectionStrings>
  -->

  <!--
    OPTION 2: Direct Production Connection String (Replace values)

    ⚠️ SECURITY WARNING: Do NOT commit production credentials to Git!

    Replace the following placeholders:
    - #{PROD_DB_SERVER}#     → your-prod-server.database.windows.net (or localhost)
    - #{PROD_DB_NAME}#       → scheduler
    - #{PROD_DB_USER}#       → your-db-username
    - #{PROD_DB_PASSWORD}#   → your-secure-password

    For Azure SQL: Use 'username@servername' format
    For Windows Auth: Remove user id/password, add 'Integrated Security=True'
  -->
  <connectionStrings>
    <add name="schedulerEntities"
         connectionString="metadata=res://*/DBEngine.csdl|res://*/DBEngine.ssdl|res://*/DBEngine.msl;provider=System.Data.SqlClient;provider connection string=&quot;data source=#{PROD_DB_SERVER}#;initial catalog=#{PROD_DB_NAME}#;persist security info=True;user id=#{PROD_DB_USER}#;password=#{PROD_DB_PASSWORD}#;trustservercertificate=True;MultipleActiveResultSets=True;App=EntityFramework&quot;"
         providerName="System.Data.EntityClient"
         xdt:Transform="SetAttributes"
         xdt:Locator="Match(name)" />
  </connectionStrings>

  <!-- ============================================
       SYSTEM.WEBSERVER: IIS Configuration
       ============================================ -->
  <system.webServer>

    <!--
      HTTP RESPONSE HEADERS: Security Headers

      Security best practices:
      - X-Frame-Options: Prevent clickjacking
      - X-Content-Type-Options: Prevent MIME sniffing
      - X-XSS-Protection: Enable browser XSS filter
      - Referrer-Policy: Control referrer information
    -->
    <httpProtocol xdt:Transform="Insert">
      <customHeaders>
        <add name="X-Frame-Options" value="SAMEORIGIN" />
        <add name="X-Content-Type-Options" value="nosniff" />
        <add name="X-XSS-Protection" value="1; mode=block" />
        <add name="Referrer-Policy" value="strict-origin-when-cross-origin" />
      </customHeaders>
    </httpProtocol>

    <!--
      HTTPS REDIRECT (Optional - Uncomment if using HTTPS)

      Automatically redirect HTTP requests to HTTPS
    -->
    <!--
    <rewrite xdt:Transform="Insert">
      <rules>
        <rule name="HTTP to HTTPS redirect" stopProcessing="true">
          <match url="(.*)" />
          <conditions>
            <add input="{HTTPS}" pattern="off" ignoreCase="true" />
          </conditions>
          <action type="Redirect" url="https://{HTTP_HOST}/{R:1}" redirectType="Permanent" />
        </rule>
      </rules>
    </rewrite>
    -->

    <!--
      HTTP COMPRESSION: Enable Gzip for better performance
    -->
    <httpCompression xdt:Transform="Insert">
      <dynamicTypes>
        <add mimeType="application/json" enabled="true" />
        <add mimeType="application/javascript" enabled="true" />
      </dynamicTypes>
    </httpCompression>

  </system.webServer>

  <!-- ============================================
       REMOVE DEBUG-ONLY SECTIONS
       ============================================ -->

  <!-- Remove system.diagnostics if exists (debug tracing) -->
  <system.diagnostics xdt:Transform="Remove" />

</configuration>
